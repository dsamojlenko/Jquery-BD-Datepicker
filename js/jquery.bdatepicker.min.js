/*!
 *
 * Business Days Datepicker
 * JQuery UI Datepicker wrapper that can disable and account for holidays and weekends.
 * Requires: Jquery, Jquery UI
 *
 * inspiration from and thanks to:
 * http://lucassmith.name/2008/11/add-business-days-to-a-date.html
 * https://github.com/lsmith/addBusinessDays
 * https://github.com/johnvpetersen/jQuery-Date-Picker-Business-Day-Filter
 *
 *
 */

(function ($) {
	$.fn.BDatePicker = function (params) {

		params = $.extend({ daysToAdd: null, noWeekends: false, holidayList: null }, params);

		var noWeekends = params.noWeekends;
		var daysToAdd = params.daysToAdd;
		var holidaysToAdd = 0;
		var holidayList = params.holidayList;
		var holidayArray = new Array();
		var startdate = new Date();


		// get holidays into an array for use later
		var count = 0;
		$.each(holidayList, function (key, item) {
			if (item.holiday.date != null) {
				holidayArray[count] = item.holiday.date;
				count++;
			}
		}

		if (daysToAdd != null) {
			var newdate = new Date();

			// account for weekends
			if (noWeekends) {
				var day = startdate.getDay();
				newdate.setDate(
					startdate.getDate() + daysToAdd +
					(day === 6 ? 2 : +!day) +
					(Math.floor((daysToAdd - 1 + (day % 6 || 1)) / 5) * 2));
			} else {
				// weekends allowed
				newdate.setDate(startdate.getDate() + daysToAdd);
			}

		}

		// account for holidays
		if (holidayList != null) {

			// maybe should just use the array?
			$.each(holidayList, function (key, item) {
				if (item.holiday.date != null) {
					
					var holidayDate = new Date(item.holiday.date);

					if (holidayDate > startdate && holidayDate < newdate) {

						// UNCOMMENT FOR GITHUB (if holiday falls on the weekend, don't count it twice)
						// var isWeekend = (holidayDate.getDay() == 6) || (holidayDate.getDay() == 0);
						// if (!isWeekend) {
						holidaysToAdd++;
						// }
					}

				} else {
					console.log("Error processing your holiday list. Review the example provided and make sure each object as a date attribute. Holiday object must conform to the following: {\"holiday\":{\"name\":\"New Years Day\",\"date\":\"1-1-2012\"}}")
				}
				
			});

			if (daysToAdd != null) {
				if (holidaysToAdd > 0) {
					newdate.setDate(newdate.getDate() + holidaysToAdd);
				}
			}

		}

		// alert(holidayList[1].holiday.date);

		return this.datepicker({
			minDate: newdate,
			beforeShowDay: function (date) {

				// if date is in our holidays array, disable it
				var sdate = $.datepicker.formatDate('mm-dd-yy', date);
				if ($.inArray(sdate, holidayArray) > -1) return [false];

				// disable weekends?
				if (noWeekends) {
					return $.datepicker.noWeekends(date);
				}
				// not sure which way is better
				// if (date.getDay() == 0 || date.getDay() == 6) return [!noWeekends];

				return [true];
			}
		});

	}
})(jQuery);